# MESSIAH 게임 기능 명세서

## 1. 개요

MESSIAH는 뱀파이어 서바이벌 장르의 2D 로그라이크 게임입니다. 플레이어는 다양한 무기를 사용하여 적들을 처치하고, 웨이브를 클리어하며, 강력한 보스와 맞서 싸웁니다. 게임은 모듈화된 구조로 개발되었으며, 오브젝트 풀링, 공간 분할 등 최적화 기법을 적용하여 안정적인 성능을 제공합니다.

---

## 2. 게임 시스템 구조

### 2.1 화면 구성

게임은 다음과 같은 화면들로 구성되어 있습니다:

- **타이틀 화면**: 게임 시작, 옵션, 도움말 메뉴 제공
- **스테이지 선택 화면**: 스테이지 선택 및 초기 무기 선택 기능
- **업그레이드 화면**: 영구 업그레이드 구매 및 플레이어 스탯 확인
- **게임 화면**: 메인 게임 플레이 화면
- **정산 화면**: 웨이브 클리어 후 무기/버프 선택
- **게임 오버 화면**: 획득 엔트로피 및 도달 웨이브 표시

### 2.2 게임 상태 관리

`GameState.js` 모듈을 통해 다음을 관리합니다:
- 플레이어 통계 (HP, 공격력, 방어력, 이동속도 등)
- 레벨 및 EXP 시스템
- 엔트로피 시스템 (통화)
- 웨이브 진행 관리
- 업그레이드 레벨 저장
- 스테이지 해금 관리

---

## 3. 스테이지 시스템

### 3.1 메인 스테이지

#### 낙원 (Stage 2)
- **이름**: 낙원
- **설명**: 승리의 정원
- **배경 타입**: 천국 (heaven)
- **최대 웨이브**: 20웨이브
- **맵 크기**: 2000x2000
- **초기 무기 선택**: 스테이지 시작 전 무기 선택 가능
- **특징**: 마지막 웨이브에 보스 스폰

### 3.2 테스트 스테이지

#### 테스트 스테이지 (Stage 99)
- **최대 웨이브**: 999 (무제한)
- **테스트 기능**:
  - **무기 추가**: 7종 무기별 개별 버튼 제공
    - 세라픽 엣지
    - 보팔 소드
    - 뒤랑달
    - 에스톡
    - 모닝스타
    - 기요틴
    - 롱기누스
  - **부활 횟수 +1**: 부활 횟수 즉시 증가
  - **대쉬 횟수 +1**: 대쉬 충전 횟수 즉시 증가
  - **보스 소환**: 미카엘 보스 즉시 소환

---

## 4. 보스 시스템

### 4.1 미카엘 (유일 보스)

#### 기본 스탯
- **HP**: 140,000
- **공격력**: 30
- **이동 속도**: 50
- **크기**: 400x400
- **골드 보상**: 150
- **EXP 보상**: 80
- **처치 보상**: 엔트로피 +10 (무기 공격으로 처치 시만)

#### 스킬 시스템

**1. 대쉬 (Dash)**
- **연속 대쉬**: 1~3회 랜덤 연속 대쉬
- **대쉬 속도**: 기본 속도 × 15
- **대쉬 데미지**: 대폭 증가
- **히트박스**: 크기 증가
- **대쉬 간 대기**: 0.2초
- **이미지**: `michael_dash.png` 사용

**2. 강화된 도약 공격 (Dive Attack Enhanced)**
- **1단계 - 준비**: 2초 대기, 강한 흔들림 효과 (화면 흔들림 10, 0.2초)
- **2단계 - 상승**: 위로 빠르게 이동 (속도 3000) 후 페이드아웃
- **3단계 - 경고 표시**: 5초간 원 경고 표시
  - 처음 4.5초: 플레이어 위치를 부드럽게 추적 (속도 0.15)
  - 마지막 0.5초: 위치 고정
- **4단계 - 낙하**: 빠르게 낙하 (속도 2000)
- **5단계 - 착지**: 착지 후 3초간 흔들림 (화면 흔들림 20, 0.5초)
- **원 경고 반지름**: 150px
- **데미지 범위**: 원 경고 표시와 정확히 동일 (반지름 150px)
- **착지 효과**: Quake 이펙트 생성 (6프레임 애니메이션)
- **방향 전환 제한**: 착지 후 michael 이미지 상태에서는 방향 전환 비활성화

#### 사망 처리
- **BGM 페이드아웃**: 0.8초 동안 페이드아웃
- **사망 사운드**: 페이드아웃 후 0.8초 지연 후 재생
- **사망 위치 고정**: 플레이어 위치로 이동하지 않음
- **카메라 처리**: 미카엘 위치로 이동 후 줌인
- **클리어 시퀀스**: 보스 처치 후 클리어 시퀀스 실행

#### 이미지 시스템
- **기본 이미지**: `michael.png` (착지 후 상태)
- **이동 이미지**: `michael_move.png` (일반 이동 상태)
- **대쉬 이미지**: `michael_dash.png` (대쉬 중)
- **사망 이미지**: `michael_dead.png` (사망 시)

---

## 5. 웨이브 시스템

### 5.1 웨이브 진행

- **웨이브 시간**: 60초 (보스 웨이브는 시간 제한 없음)
- **Stage 2**: 최대 10웨이브
- **마지막 웨이브**: 보스 스폰, 타이머 표시 없음
- **웨이브 클리어 조건**:
  - 모든 적 처치
  - 또는 시간 종료

### 5.2 적 스폰 시스템

- **스폰 위치**: 맵 경계 (상/하/좌/우)
- **등장 마커**: 등장 전 `<!>` 표시 (크기 확대)
- **스폰 간격**: 0.5초
- **적 타입별 스폰 주기**:
  - **말라크**: 5초마다 (4 + 웨이브)마리
  - **파워**: 5초마다 (0 + 웨이브)마리
  - **도미니온**: 10초마다 (1 + 웨이브)마리
  - **핀드**: 5초마다 (4 + 웨이브)마리
  - **컬티스트**: 5초마다 (0 + 웨이브)마리
  - **나이트메어**: 10초마다 (1 + 웨이브)마리

### 5.3 웨이브 클리어 보상

- **체력 회복**: 최대 체력의 30% 회복
- **클리어 애니메이션**: 떨어지는 표지판 애니메이션
- **정산 화면 전환**: 3초 후 정산 화면으로 전환

---

## 6. 플레이어 시스템

### 6.1 기본 스탯

- **크기**: 96x96
- **기본 체력**: 업그레이드에 따라 변동
- **기본 공격력**: 업그레이드에 따라 변동
- **기본 이동 속도**: 업그레이드에 따라 변동

### 6.2 이동 시스템

- **입력**: WASD (8방향)
- **대각선 이동**: 정규화 처리
- **방향 전환**: 좌우 방향에 따라 이미지 뒤집기

### 6.3 대쉬 시스템

- **입력**: 스페이스바
- **기본 대쉬 차지**: 1개
- **최대 대쉬 차지**: 업그레이드로 최대 2개까지 증가
- **쿨다운**: 대쉬 사용 후 쿨다운 시작
- **충전 방식**: 쿨다운 완료 시 한 개씩 충전 (즉시 모두 충전되지 않음)
- **무적 시간**: 대쉬 중 무적 상태
- **대쉬 속도**: 750
- **대쉬 지속 시간**: 0.25초

### 6.4 부활 시스템

- **기본 부활 횟수**: 0
- **최대 부활 횟수**: 업그레이드로 최대 2회까지 증가
- **부활 애니메이션**: "...?" 텍스트 타이핑 효과
- **부활 대기 시간**: 3초
- **부활 후 무적**: 3초간 무적 상태

### 6.5 체력/스태미나 게이지바

- **체력바 위치**: 플레이어 머리 위 -10px
- **스태미나바 위치**: 플레이어 머리 위 +5px
- **스태미나바 크기**: 가로 50px
- **체력바 표시 조건**: 체력이 최대가 아닐 때만 표시

### 6.6 애니메이션 시스템

- **Idle 애니메이션**: 4프레임
- **Running 애니메이션**: 8프레임
- **사망 애니메이션**: falling-back-death (느린 재생, 프레임 시간 0.5초)
- **부활 애니메이션**: getting-up (프레임 시간 0.1초)
- **프레임 지속 시간**: 0.1초

### 6.7 잔상 효과

- **잔상 생성 간격**: 0.05초
- **잔상 지속 시간**: 0.3초
- **잔상 효과**: 하얀색 틴트 적용, 투명도 페이드아웃
- **오프스크린 캔버스**: 배경 영향 없이 렌더링

---

## 7. 무기 시스템

### 7.1 사용 가능한 무기 (7종)

#### 1. 세라픽 엣지
- **데미지**: 40
- **치명타 확률**: +20%
- **치명타 데미지**: +10%
- **쿨다운**: 2.0초
- **넉백**: 1
- **범위**: 300px
- **구매 비용**: 50

#### 2. 보팔 소드
- **데미지**: 30
- **치명타 확률**: +30%
- **치명타 데미지**: +15%
- **쿨다운**: 1.0초
- **넉백**: 0
- **범위**: 300px
- **구매 비용**: 40

#### 3. 뒤랑달
- **데미지**: 50
- **치명타 확률**: +5%
- **치명타 데미지**: +20%
- **쿨다운**: 2.5초
- **넉백**: 2
- **범위**: 300px
- **구매 비용**: 60

#### 4. 에스톡
- **데미지**: 20
- **치명타 확률**: +50%
- **치명타 데미지**: +50%
- **쿨다운**: 1.0초
- **넉백**: 0
- **범위**: 200px
- **구매 비용**: 50

#### 5. 모닝스타
- **데미지**: 60
- **치명타 확률**: +0%
- **치명타 데미지**: +20%
- **쿨다운**: 3.0초
- **넉백**: 3
- **범위**: 200px
- **구매 비용**: 75

#### 6. 기요틴
- **데미지**: 40
- **치명타 확률**: +20%
- **치명타 데미지**: +40%
- **쿨다운**: 2.0초
- **넉백**: 0
- **범위**: 250px
- **특수 효과**: 공격 시 회전 효과
- **구매 비용**: 55

#### 7. 롱기누스
- **데미지**: 50
- **치명타 확률**: +40%
- **치명타 데미지**: +50%
- **쿨다운**: 2.5초
- **넉백**: 0
- **범위**: 350px
- **구매 비용**: 65

### 7.2 무기 시스템 특징

- **최대 슬롯**: 6개
- **초기 무기 선택**: 스테이지 시작 전 무기 선택 가능
- **무기 합체**: 같은 무기, 같은 등급 → 등급 +1 (최대 4등급)
- **무기 판매**: 무기 판매 가능
- **등급별 스탯 증가**: 등급당 40% 증가
- **등급별 테두리 색상**: 
  - 2등급: 파란색
  - 3등급: 보라색
  - 4등급: 빨간색
- **발사체 기반 스킬 제거**: 더블샷, 투사체 폭발 등 제거됨

---

## 8. 통화 및 업그레이드 시스템

### 8.1 통화: 엔트로피

- **획득 방법**:
  - 적 30마리 처치 시 +1
  - 미카엘 처치 시 +10
- **특징**: 스테이지 초기화와 무관하게 누적
- **사용처**: 영구 업그레이드 구매

### 8.2 업그레이드 항목

#### 기본 스탯 업그레이드 (최대 레벨: 무제한)

| 항목 | 설명 | 비용 (엔트로피) | 증가량 |
|------|------|----------------|--------|
| 체력 | 최대 체력 +20 | 2 | +20 |
| 체력 재생 | 초당 체력 재생 +0.5 | 1 | +0.5 |
| 방어력 | 방어력 +2 | 2 | +2 |
| 공격력 | 공격력 +5 | 2 | +5 |
| 공격 속도 | 공격 속도 +0.2 | 2 | +0.2 |
| 치명타율 | 치명타율 +5% | 3 | +5% |
| 치명타 데미지 | 치명타 데미지 +1% | 3 | +1% |
| 이동 속도 | 이동 속도 +10 | 2 | +10 |
| 행운 | 금화 획득 +10% | 1 | +10% |
| 숙련도 | EXP 획득 +10% | 1 | +10% |

#### 특수 업그레이드

| 항목 | 설명 | 비용 (엔트로피) | 최대 레벨 |
|------|------|----------------|----------|
| 부활 횟수 | 부활 횟수 +1 | 10 | 2 |
| 대쉬 2차지 해금 | 대쉬 충전 횟수 +1 | 10 | 1 |

### 8.3 업그레이드 UI

- **레이아웃**: 4x3 그리드 (좌측), 플레이어 스탯 표시 (우측)
- **높이**: 업그레이드 항목 영역과 플레이어 스탯 영역 높이 동일
- **가로 넓이**: 업그레이드 항목 가로 넓이 확대 (텍스트 줄바꿈 최소화)
- **레벨 표시 형식**:
  - 최대 레벨 도달: `MAX`
  - 무제한 업그레이드: `Lv.현재레벨`
  - 제한된 업그레이드: `Lv.현재레벨/최대레벨`
- **텍스트 정렬**:
  - 이름: 상단 중앙
  - 레벨: 이름 아래 줄바꿈
  - 설명: 중앙
  - 비용: 하단 중앙

---

## 9. UI/렌더링 시스템

### 9.1 게임 내 HUD (캔버스 내부 렌더링)

- **레벨 표시**: 현재 레벨
- **EXP 게이지바**: 현재 EXP / 다음 레벨 필요 EXP
- **웨이브 정보**: 상단 중앙, 폰트 크기 확대
- **남은 시간**: 상단 중앙, 폰트 크기 확대 (마지막 웨이브 제외)
- **엔트로피 표시**: 현재 엔트로피

### 9.2 게임 오버 화면

- **획득 엔트로피**: 게임 시작 시 엔트로피 대비 증가량 표시
- **도달 웨이브**: 최종 도달 웨이브 표시

### 9.3 정산 화면

- **무기 선택**: 무기 구매 및 합체
- **버프 선택**: 공격 속도, 치명타 강화, 체력 강화 등

### 9.4 ESC 메뉴

- **플레이어 스탯 표시**: 현재 플레이어 스탯
- **무기 목록**: 보유 중인 무기 표시

---

## 10. 게임 진행 시스템

### 10.1 레벨 시스템

- **레벨업 조건**: EXP가 필요량에 도달하면 자동 레벨업
- **EXP 필요량**: 100 × 1.2^(레벨-1)
- **레벨업 보상**: 스킬포인트 +1

### 10.2 행운/숙련도 시스템

- **행운**: 금화 획득 보너스 (행운 × 100%)
- **숙련도**: EXP 획득 보너스 (숙련도 × 100%)

### 10.3 웨이브 클리어 애니메이션

- 떨어지는 표지판 애니메이션
- "Wave X Clear!" 메시지 표시
- 3초 후 정산 화면으로 전환

---

## 11. 적 시스템

### 11.1 적 타입

게임에는 총 6종류의 적이 존재합니다:

#### 천사 타입 (Angel)
1. **말라크**
   - HP: 50
   - 공격력: 5
   - 이동 속도: 150
   - 골드: 2
   - EXP: 5
   - 크기: 100x100

2. **파워**
   - HP: 80
   - 공격력: 7
   - 이동 속도: 180
   - 골드: 3
   - EXP: 7
   - 크기: 100x100
   - 특수 능력: 돌진 공격

3. **도미니온**
   - HP: 120
   - 공격력: 8
   - 이동 속도: 150
   - 골드: 4
   - EXP: 10
   - 크기: 130x130

#### 악마 타입 (Devil)
4. **핀드**
   - HP: 35
   - 공격력: 6
   - 이동 속도: 165
   - 골드: 2
   - EXP: 6
   - 크기: 100x100

5. **컬티스트**
   - HP: 60
   - 공격력: 5
   - 이동 속도: 140
   - 골드: 2
   - EXP: 5
   - 크기: 100x100

6. **나이트메어**
   - HP: 200
   - 공격력: 12
   - 이동 속도: 120
   - 골드: 5
   - EXP: 15
   - 크기: 150x150

### 11.2 적 AI

- **플레이어 추적**: 플레이어를 향해 이동
- **공격 범위**: 적 타입별 공격 범위 설정
- **공격 쿨타임**: 공격 후 쿨타임 적용

---

## 12. 기술적 특징

### 12.1 최적화 기법

#### 1. 오브젝트 풀링
- **적**: 300개 풀
- **투사체**: 500개 풀
- **효과**: 생성/파괴 대신 활성/비활성화로 메모리 할당 최소화

#### 2. 공간 분할
- **그리드 기반 충돌 검사**: 200x200 셀
- **주변 3x3 그리드만 검사**: 성능 최적화
- **거리 기반 사전 필터링**: 무거운 AABB 충돌 전 거리 계산

#### 3. 배치 렌더링
- **같은 색상의 적/투사체 묶어서 렌더링**: 드로우 콜 최소화
- **오프스크린 캔버스**: 잔상 효과 등 특수 효과 처리

### 12.2 코드 구조

- **모듈화된 구조**: 각 시스템별 독립 파일
- **명확한 함수명 및 주석**: 코드 가독성 향상
- **재사용 가능한 코드 구조**: 유지보수성 향상

### 12.3 충돌 시스템

- **플레이어 피격 판정**: 40% (작게)
- **적 피격 판정**: 85% (약간 작게)
- **플레이어 공격 판정**: 130% (크게)
- **AABB 충돌 검사**: 정확한 충돌 판정

---

## 13. 파일 구조

```
MESSIAH/
├── index.html              # 메인 HTML 파일
├── FEATURES.md            # 게임 기능 명세서
├── css/
│   └── style.css          # 스타일시트
├── js/
│   ├── GameState.js       # 게임 상태 관리
│   ├── InputManager.js    # 입력 관리
│   ├── Player.js          # 플레이어 시스템
│   ├── Enemy.js           # 적 시스템
│   ├── Projectile.js      # 투사체 시스템
│   ├── CollisionSystem.js # 충돌 시스템
│   ├── MapSystem.js       # 맵 시스템
│   ├── WaveSystem.js      # 웨이브 시스템
│   ├── SkillSystem.js     # 무기 시스템
│   ├── BossSystem.js      # 보스 시스템
│   ├── SettlementSystem.js # 정산 시스템
│   ├── SpeechBubble.js    # 말풍선 시스템
│   ├── ResourceLoader.js  # 리소스 로더
│   └── MESSIAH.js         # 메인 게임 로직
└── images/                # 이미지 리소스
```

---

## 14. 조작 방법

- **이동**: WASD (8방향)
- **대쉬**: Spacebar (쿨타임 존재)
- **공격**: 자동 (무기 시스템)
- **ESC**: 게임 메뉴

---

## 15. 게임 사양

- **캔버스 크기**: 1200x600
- **맵 크기**: 2000x2000
- **프레임레이트**: requestAnimationFrame 기반
- **델타타임**: 프레임 독립적 업데이트
- **폰트**: Sam3KRFont

---

## 16. 변경 이력

### 최신 변경사항
- 웨이브 시간: 10초 → 60초
- 치명타 데미지 업그레이드: 10% → 1%
- 통화: 골드 → 엔트로피
- 미카엘 HP: 24,000 → 140,000
- 미카엘 처치 보상: 엔트로피 +10 추가
- 투사체 시스템 제거
- 초기 무기 선택 기능 추가
- 테스트 스테이지 무기별 버튼 추가
- 업그레이드 UI 개선 (4x3 그리드, 스탯 표시)
- HUD 캔버스 내부 렌더링으로 변경

---

## 17. 결론

MESSIAH는 뱀파이어 서바이벌 장르의 핵심 요소들을 구현한 2D 로그라이크 게임입니다. 다양한 무기 시스템, 업그레이드 시스템, 보스 전투 등 다양한 게임플레이 요소를 제공하며, 오브젝트 풀링, 공간 분할 등 최적화 기법을 통해 안정적인 성능을 보장합니다. 모듈화된 코드 구조로 유지보수성과 확장성이 뛰어나며, 지속적인 업데이트와 개선이 가능한 구조로 설계되었습니다.
